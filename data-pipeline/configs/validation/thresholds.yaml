# =============================================================================
# BOSTON PULSE - VALIDATION THRESHOLDS
# =============================================================================
# Data quality and validation thresholds for all datasets.
# These values are used by src/validation/schema_enforcer.py
# =============================================================================

# -----------------------------------------------------------------------------
# Global Data Quality Thresholds
# -----------------------------------------------------------------------------
global:
  # Null value thresholds
  null_ratio:
    default: 0.05  # 5% null allowed by default
    critical_columns: 0.0  # Primary keys, required fields
    optional_columns: 0.20  # Non-critical columns

  # Duplicate detection
  duplicates:
    max_ratio: 0.01  # 1% duplicates allowed
    check_columns: ["id", "primary_key"]  # Columns to check for duplicates

  # Row count expectations
  row_count:
    min_absolute: 100  # Fail if fewer than 100 rows
    max_decrease_ratio: 0.5  # Fail if 50%+ drop from previous run
    max_increase_ratio: 3.0  # Warn if 3x+ increase

# -----------------------------------------------------------------------------
# Schema Validation
# -----------------------------------------------------------------------------
schema:
  # Validation modes
  mode: "strict"  # strict | permissive

  # Column type enforcement
  type_coercion:
    enabled: true
    fail_on_error: true

  # Extra columns handling
  extra_columns:
    action: "drop"  # drop | warn | fail
    log_columns: true

# -----------------------------------------------------------------------------
# Temporal Validation
# -----------------------------------------------------------------------------
temporal:
  # Timestamp bounds
  max_future_days: 1  # Allow 1 day in future (timezone)
  max_past_years: 10  # Flag data older than 10 years

  # Recency check
  recency:
    warn_if_stale_hours: 48  # Warn if no data in 48 hours
    fail_if_stale_hours: 168  # Fail if no data in 7 days

  # Date format validation
  formats:
    accepted:
      - "%Y-%m-%d"
      - "%Y-%m-%dT%H:%M:%S"
      - "%Y-%m-%dT%H:%M:%SZ"
      - "%Y-%m-%d %H:%M:%S"

# -----------------------------------------------------------------------------
# Geographic Validation (Boston Area)
# -----------------------------------------------------------------------------
geographic:
  # Boston bounding box
  bounds:
    min_latitude: 42.2279
    max_latitude: 42.3969
    min_longitude: -71.1912
    max_longitude: -70.9235

  # Allow some points outside bounds (edge cases)
  out_of_bounds:
    max_ratio: 0.02  # 2% can be outside bounds
    action: "flag"  # flag | drop | fail

  # Invalid coordinate handling
  invalid_coords:
    null_allowed: true
    null_max_ratio: 0.10  # 10% missing coords allowed

# -----------------------------------------------------------------------------
# Numeric Validation
# -----------------------------------------------------------------------------
numeric:
  # Outlier detection (IQR method)
  outliers:
    iqr_multiplier: 3.0  # Points beyond Q1-3*IQR or Q3+3*IQR
    action: "flag"  # flag | cap | drop
    max_ratio: 0.05  # 5% outliers allowed

  # Range validation (per-column overrides in dataset configs)
  ranges:
    default:
      allow_negative: false
      allow_zero: true

# -----------------------------------------------------------------------------
# Categorical Validation
# -----------------------------------------------------------------------------
categorical:
  # Unknown category handling
  unknown_categories:
    action: "flag"  # flag | map_to_other | fail
    max_ratio: 0.10  # 10% unknown allowed

  # Cardinality limits
  cardinality:
    warn_if_above: 100
    fail_if_above: 1000

# -----------------------------------------------------------------------------
# Dataset-Specific Thresholds
# -----------------------------------------------------------------------------
datasets:
  crime:
    null_ratio:
      offense_code: 0.0
      occurred_on_date: 0.0
      lat: 0.10
      long: 0.10

    row_count:
      min_absolute: 1000  # Crime data should have many records

  service_311:
    null_ratio:
      case_enquiry_id: 0.0
      open_dt: 0.0
      subject: 0.05

    temporal:
      max_past_years: 5  # 311 data less historical

  mbta:
    # Streaming data - different expectations
    null_ratio:
      vehicle_id: 0.0
      timestamp: 0.0
      latitude: 0.05
      longitude: 0.05

    recency:
      warn_if_stale_minutes: 5
      fail_if_stale_minutes: 15

  vision_zero:
    null_ratio:
      crash_number: 0.0
      crash_date: 0.0

  streetlight:
    row_count:
      min_absolute: 50000  # Many streetlights in Boston

    geographic:
      out_of_bounds:
        max_ratio: 0.01  # Streetlights should be in Boston

  fire:
    null_ratio:
      incident_number: 0.0
      alarm_time: 0.0

# -----------------------------------------------------------------------------
# Validation Actions
# -----------------------------------------------------------------------------
actions:
  # What to do when validation fails
  on_failure:
    schema_violation: "fail"  # Always fail on schema issues
    quality_violation: "warn"  # Warn but continue
    critical_violation: "fail"  # Fail on critical issues

  # Reporting
  reporting:
    generate_report: true
    report_format: "json"
    include_samples: true
    sample_size: 10
